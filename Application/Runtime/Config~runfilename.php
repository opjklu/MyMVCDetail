<?php namespace {defined("MyMVC_PATH") or exit("No Resource"); function getConfig($key=NULL , $value = NULL , $default = NULL) { static $config = array(); if (empty($key)){ return $config; } if (is_string($key)){ if (!strpos(".", $key)){ if (is_null($value)) return isset($config[$key]) ? $config[$key] : $default; $config[$key] = $value; return ; } $arrayKeyValue = explode(".", $key); $arrayKeyValue[0] = strtolower($arrayKeyValue[0]); if (is_null($value)) return isset($config[ $arrayKeyValue[0] ] [ $arrayKeyValue[1]] )? $config[$arrayKeyValue[0]][$arrayKeyValue[1]] : $default; $config[$arrayKeyValue[0]][$arrayKeyValue[1]] = $value; return ; } if (is_array($key)){ $config = array_merge($config , array_change_key_case($key , CASE_UPPER)); return ; } return null; } function redirect($url , $time=0 , $message = "") { $url = str_replace(array("\r" , "\n"), '', $url); empty($message) ? "系统将在{$time}秒后跳到{$url}" : $message; if (!headers_sent()){ !empty($url) ? header("refresh:{$time};Location:{$url}"): false; print_r($message); exit(); }else { header("<meta http-equiv='refresh' content='{$time};url={$url}' />"); $time === 0?exit():showData($message); } } function compile($filename) { $content = php_strip_whitespace($filename); $content = trim(substr($content, 5)); $content = preg_replace('/\/\/\[RUNTIME\](.*?)\/\/\[\/RUNTIME\]/s', '', $content); $content = 0===strpos($content,'namespace') ? preg_replace('/namespace\s(.*?);/','namespace \\1{',$content,1) : 'namespace {'.$content; $content = '?>' == substr($content, -2) ? substr($content, 0, -2) : $content; return $content.'}'; } function getMemory($start , $end = "" , $dec = 6) { static $memory = array(); static $appInfo = array(); is_float($end) ? $appInfo[$end] = $start : false; if (!empty($end)){ !isset($appInfo[$end]) ? $appInfo[$end] = microtime(true) : false; return MEMORY_USE&&$dec == "m" ? (!isset($memory[$end]) ? number_format( (($memory[$end]=memory_get_usage())-$memory[$start])/1024 ) : false ) : number_format( (($memory[$end]=memory_get_usage())-$memory[$start]),$dec ); }else { MEMORY_USE ? $memory[$start] = memory_get_usage() : false; $appInfo[$start] = microtime(true); } } function getTrace($value="[MyMVC]" , $lable="" , $level = "DEBUG", $record = FALSE) { return MyMVC\MyMVC::getTrace($value , $lable , $level , $record); } function getError($message , $code=null) { throw new MyMVC\Error($message , $code); } function getLanage($name =null , $value = null) { static $lanage = array(); if (empty($name)) return $lanage; if (is_string($name)){ $name = strtoupper($name); if (is_null($value)){ return isset($lanage[$name]) ? $lanage[$name] : $name; }elseif (is_array($value)){ $replace = array_keys($value); foreach ($replace as &$val){ $val = '{$'.$val."}"; } $content = str_replace($replace, $value, isset($lanage[$name]) ? $lanage[$name] : $name ); return $content; } $lanage[$name] = $value; } is_array($name) ? $lanage = array_merge($lanage , array_change_key_case($name , CASE_UPPER)) : false; return ; } function strip_space($content) { $strip = ''; $content = token_get_all($content); $last_space = false; for ($i = 0 , $j= count($content); $i <$j; $i++) { if (is_string($content[$i])){ $strip .= $content[$i]; $last_space = false; }else { switch ($content[$i][0]){ case T_COMMENT: case T_DOC_COMMENT: break; case T_WHITESPACE: if (!$last_space){ $strip .= ' '; $last_space = true; } break; case T_START_HEREDOC: $strip .="<<<MyMVC\n"; break; case T_END_HEREDOC: $strip .= "MyMVC\n"; for ($k = $i+1 ; $k < $j ; $k++){ if ($content[$k] == ";" && is_string($content[$k])){ $i = $k; break; }elseif ($content[$i][0] == T_CLOSE_TAG){ break; } } break; default: $strip .= $content[$i][1]; $last_space = false; break; } } } return $strip; } function loadExtFile($path) { if ($customFile = getConfig("__CUSTOM_FILE__")){ foreach ($customFile as $key => $value){ $file = $path."Common/".$value.".php"; is_file($file) ? require_once $file : false; } } if ($customConfigFile = getConfig("__CUSTOM_CONFIG_FILE__")){ foreach ($customFile as $key => $value){ $file = $path."Config/".$value.".php"; is_file($file) ? require_once $file : false; } } } function parseURLParam($urlParam , $splice = "&" , $action='a') { $spliceParam = strstr($urlParam, $splice.$action); strrpos($spliceParam, $splice.getConfig("VAR_MODULE"))|| strrpos($spliceParam, $splice.getConfig("VAR_CONTROLLER")) || strrpos($spliceParam, $splice.getConfig("VAR_ACTION"))? die(getError("参数重复出现")) : false ; static $parseParam = array(); if (strpos( $urlParam , $splice)){ foreach (explode($splice,$urlParam) as $key => $value) { parseURLParam($value , "="); $key % 2 ===0 ? $baseParam[] = $value : ($key % 2 === 1 ? $param[] = $value : false); } foreach ($baseParam as $keyValue => $valueKey){ if (!empty($param[$keyValue])) { if ($keyValue%2 === 0){ $parseParam[$valueKey] = $param[$keyValue]; }elseif ($keyValue %2 === 1){ $parseParam[$valueKey] = $param[$keyValue]; } } } unset($baseParam); unset($param); foreach ($parseParam as $k => $v ){ if (strpos($k,'=')){ unset($parseParam[$k]); } } return $parseParam; }else { return null; } } function showData($data , $isDie = false) { $fileData = debug_backtrace(); ob_start(); print_r($data); $info['content'] =ob_get_clean(); $str = '<pre style="padding:10px;border-radius:5px;background:#F5F5F5;border:1px solid #aaa;font-size:14px;line-height:18px;">'; $str .= "\r\n"; $str .= '<strong>FILE</strong>: ' . $fileData[0]['file'] . " <br />"; $str .= '<strong>LINE</strong>: ' . $fileData[0]['line'] . " <br />"; $str .= '<strong>TYPE</strong>: ' . gettype($data) . " <br />"; $str .= '<strong>CONTENT</strong>: ' . trim($info['content'], "\r\n"); $str .= "\r\n"; $str .= "</pre>"; echo $str; $isDie === false ? false : die(); } function cookie($key = null , $value = null , array $options = null) { $config = array( 'expire' => getConfig('COOKIE_EXPIRE'), 'perfix' => getConfig('COOKIE_PREFIX'), 'domain' => getConfig('COOKIE_DOMAIN'), 'path' => getConfig('COOKIE_PATH') ); if (!empty($options)){ $arrayKey = array_keys($config); foreach ($options as $key => $valueData){ if (!array_key_exists($valueData, $arrayKey)){ getError('键'.$valueData.'在数组options不存在' , 1); die(); } } $config = array_merge($config , array_change_key_case($options , CASE_LOWER)); } if (empty($key)){ if (empty($_COOKIE)){ return null; } $name = empty($value) ? $config['perfix'] : $value; if (!empty($name)) { foreach ($_COOKIE as $keyOfCookie => $valueOfCookie) { if (0 === strpos($keyOfCookie, $name)){ setcookie($keyOfCookie , '' , time()-3600 ,$config['path'] , $config['domain'] ); unset($_COOKIE[$keyOfCookie]); } } } else { return null; } } $name = $config['perfix'].$key; if ('' === $value) { if ( !empty($name) && !empty($_COOKIE[$name])){ $value = $_COOKIE[$name]; return 0 === strpos($value, 'MyMVC_') ? array_map('urldecode', json_decode( MAGIC_QUOTE? stripcslashes(substr($value, 6)) : $value , true)) : $value; }else { return null; } } else { if (!empty($value)) { setcookie($name , '' , time()-3600 , $config['path'] , $config ['domain']); unset($_COOKIE[$name]); } else { $value = is_array($value) ? 'MyMVC_'.json_encode(array_map('urlencode', $value)) : $value; $expire = !empty($config['expire']) ? $config['expire']+time() : 3600; setcookie($name , $value , $expire , $config['path'] , $config['domain']); $_COOKIE[$name] = $value; } } } function isSetDefaultValue(array &$array, array $setKey, $default = null, $isDiffKey = 'page') { if (empty($setKey)) { return null; } foreach ($setKey as $value) { if (!array_key_exists($value, $array) && $value != $isDiffKey) { $array[$value] = $default; } elseif (!isset($array[$value])) { $array[$value] = 1; } } return $array; } function loadTemplateFile($template=null, $layer=null) { if(false === strpos($template,'://')){ $template = 'http://'.str_replace(':', '/',$template); } $info = parse_url($template); $file = $info['host'].(isset($info['path'])?$info['path']:''); $module = isset($info['user'])?$info['user'].'/':__MODULE__.'/'; $extend = $info['scheme']; $layer = $layer?$layer:getConfig('DEFAULT_V_LAYER'); if($view_path = getConfig('VIEW_PATH')){ $baseUrl = $view_path.$module.'/'; }else{ $baseUrl = APP_PATH.$module.$layer.'/'; } $theme = substr_count($file,'/')<2 ? getConfig('DEFAULT_THEME') : ''; $depr = getConfig('TMPL_FILE_DEPR'); if('' == $file) { $file = __CONTROLLER__ . $depr . __ACTION__; }elseif(false === strpos($file, '/')){ $file = __CONTROLLER__ . $depr . $file; }elseif('/' != $depr){ if(substr_count($file,'/')>1){ $file = substr_replace($file,$depr,strrpos($file,'/'),1); }else{ $file = str_replace('/', $depr, $file); } } return $baseUrl.($theme?$theme.'/':'').$file.getConfig('TMPL_TEMPLATE_SUFFIX'); }} namespace { MyMVC\MyMVC::addMap(array ( 'MyMVC\\Storage' => 'MyMVC\\Storage', 'MyMVC\\Storage\\Dirver\\File' => 'MyMVC\\Storage\\Dirver\\File', 'MyMVC\\Hook' => 'MyMVC\\Hook', )); getLanage(array ( '_MODULE_NOT_EXIST_' => '无法加载模块', '_CONTROLLER_NOT_EXIST_' => '无法加载控制器', '_ERROR_ACTION_' => '非法操作', '_LANGUAGE_NOT_LOAD_' => '无法加载语言包', '_TEMPLATE_NOT_EXIST_' => '模板不存在', '_MODULE_' => '模块', '_ACTION_' => '操作', '_MODEL_NOT_EXIST_' => '模型不存在或者没有定义', '_VALID_ACCESS_' => '没有权限', '_XML_TAG_ERROR_' => 'XML标签语法错误', '_DATA_TYPE_INVALID_' => '非法数据对象！', '_OPERATION_WRONG_' => '操作出现错误', '_NOT_LOAD_DB_' => '无法加载数据库', '_NO_DB_DRIVER_' => '无法加载数据库驱动', '_NOT_SUPPORT_DB_' => '系统暂时不支持数据库', '_NO_DB_CONFIG_' => '没有定义数据库配置', '_NOT_SUPPERT_' => '系统不支持', '_CACHE_TYPE_INVALID_' => '无法加载缓存类型', '_FILE_NOT_WRITEABLE_' => '目录（文件）不可写', '_METHOD_NOT_EXIST_' => '方法不存在！', '_CLASS_NOT_EXIST_' => '实例化一个不存在的类！', '_CLASS_CONFLICT_' => '类名冲突', '_TEMPLATE_ERROR_' => '模板引擎错误', '_CACHE_WRITE_ERROR_' => '缓存文件写入失败！', '_TAGLIB_NOT_EXIST_' => '标签库未定义', '_OPERATION_FAIL_' => '操作失败！', '_OPERATION_SUCCESS_' => '操作成功！', '_SELECT_NOT_EXIST_' => '记录不存在！', '_EXPRESS_ERROR_' => '表达式错误', '_TOKEN_ERROR_' => '表单令牌错误', '_RECORD_HAS_UPDATE_' => '记录已经更新', '_NOT_ALLOW_PHP_' => '模板禁用PHP代码', '_PARAM_ERROR_' => '参数错误或者未定义', '_FILE_NOT_EXITS' => '文件不存在', )); getConfig(array ( 'APP_FILE_CASE' => false, 'APP_SUB_DOMAIN_DEPLOY' => false, 'APP_SUB_DOMAIN_RULES' => array ( ), 'APP_DOMAIN_SUFFIX' => '', 'ACTION_SUFFIX' => '', 'MULTI_MODULE' => true, 'MODULE_DENY_LIST' => array ( 0 => 'Common', 1 => 'Runtime', ), 'CONTROLLER_LEVEL' => 1, 'COOKIE_EXPIRE' => 0, 'COOKIE_DOMAIN' => '', 'COOKIE_PATH' => '/', 'COOKIE_PREFIX' => 'wq_', 'DEFAULT_M_LAYER' => 'Model', 'DEFAULT_C_LAYER' => 'Controller', 'CONTROLLER_PEFEX' => 'Controller', 'DEFAULT_V_LAYER' => 'View', 'DEFAULT_LANG' => 'zh-cn', 'DEFAULT_THEME' => '', 'DEFAULT_MODULE' => 'Home', 'DEFAULT_CONTROLLER' => 'Index', 'DEFAULT_ACTION' => 'index', 'DEFAULT_CHARSET' => 'utf-8', 'DEFAULT_TIMEZONE' => 'PRC', 'DEFAULT_AJAX_RETURN' => 'JSON', 'DEFAULT_JSONP_HANDLER' => 'jsonpReturn', 'DEFAULT_FILTER' => 'htmlspecialchars', 'DB_TYPE' => '', 'DB_HOST' => '', 'DB_NAME' => '', 'DB_USER' => '', 'DB_PWD' => '', 'DB_PORT' => '', 'DB_PREFIX' => '', 'DB_FIELDTYPE_CHECK' => false, 'DB_FIELDS_CACHE' => true, 'DB_CHARSET' => 'utf8', 'DB_DEPLOY_TYPE' => 0, 'DB_RW_SEPARATE' => false, 'DB_MASTER_NUM' => 1, 'DB_SLAVE_NO' => '', 'DB_SQL_BUILD_CACHE' => false, 'DB_SQL_BUILD_QUEUE' => 'file', 'DB_SQL_BUILD_LENGTH' => 20, 'DB_SQL_LOG' => false, 'DB_BIND_PARAM' => false, 'DATA_CACHE_TIME' => 0, 'DATA_CACHE_COMPRESS' => false, 'DATA_CACHE_CHECK' => false, 'DATA_CACHE_PREFIX' => '', 'DATA_CACHE_TYPE' => 'File', 'DATA_CACHE_PATH' => './Application/Runtime/cache/', 'DATA_CACHE_SUBDIR' => false, 'DATA_PATH_LEVEL' => 1, 'ERROR_MESSAGE' => '页面错误！请稍后再试～', 'ERROR_PAGE' => '', 'SHOW_ERROR_MSG' => false, 'TRACE_EXCEPTION' => false, 'TRACE_MAX_RECORD' => 100, 'LOG_RECORD' => false, 'LOG_TYPE' => 'File', 'LOG_LEVEL' => 'EMERG,ALERT,CRIT,ERR', 'LOG_FILE_SIZE' => 2097152, 'LOG_EXCEPTION_RECORD' => false, 'SESSION_AUTO_START' => true, 'SESSION_OPTIONS' => array ( ), 'SESSION_TYPE' => '', 'SESSION_PREFIX' => '', 'TMPL_CONTENT_TYPE' => 'text/html', 'TMPL_ACTION_ERROR' => 'E:\\wamp\\wamp\\www\\MyMVCDeatal\\MyMVC/Tpl/dispatch_jump.tpl', 'TMPL_ACTION_SUCCESS' => 'E:\\wamp\\wamp\\www\\MyMVCDeatal\\MyMVC/Tpl/dispatch_jump.tpl', 'TMPL_EXCEPTION_FILE' => 'E:\\wamp\\wamp\\www\\MyMVCDeatal\\MyMVC/Tpl/MyMVC_exception.tpl', 'TMPL_DETECT_THEME' => false, 'TMPL_TEMPLATE_SUFFIX' => '.html', 'TMPL_FILE_DEPR' => '/', 'TMPL_ENGINE_TYPE' => 'MyMVC', 'TMPL_CACHFILE_SUFFIX' => '.php', 'TMPL_DENY_FUNC_LIST' => 'echo,exit', 'TMPL_DENY_PHP' => false, 'TMPL_L_DELIM' => '{', 'TMPL_R_DELIM' => '}', 'TMPL_VAR_IDENTIFY' => 'array', 'TMPL_STRIP_SPACE' => true, 'TMPL_CACHE_ON' => true, 'TMPL_CACHE_PREFIX' => '', 'TMPL_CACHE_TIME' => 0, 'TMPL_LAYOUT_ITEM' => '{__CONTENT__}', 'LAYOUT_ON' => false, 'LAYOUT_NAME' => 'layout', 'TAGLIB_BEGIN' => '<', 'TAGLIB_END' => '>', 'TAGLIB_LOAD' => true, 'TAGLIB_BUILD_IN' => 'wq', 'TAGLIB_PRE_LOAD' => '', 'URL_CASE_INSENSITIVE' => true, 'URL_MODEL' => 1, 'URL_PATHINFO_DEPR' => '/', 'URL_PATHINFO_FETCH' => 'ORIG_PATH_INFO,REDIRECT_PATH_INFO,REDIRECT_URL', 'URL_REQUEST_URI' => 'REQUEST_URI', 'URL_HTML_SUFFIX' => 'html', 'URL_DENY_SUFFIX' => 'ico|png|gif|jpg', 'URL_PARAMS_BIND' => true, 'URL_PARAMS_BIND_TYPE' => 0, 'URL_404_REDIRECT' => '', 'URL_ROUTER_ON' => false, 'URL_ROUTE_RULES' => array ( ), 'URL_MAP_RULES' => array ( ), 'VAR_MODULE' => 'm', 'VAR_CONTROLLER' => 'c', 'VAR_ACTION' => 'a', 'VAR_AJAX_SUBMIT' => 'ajax', 'VAR_JSONP_HANDLER' => 'callback', 'VAR_PATHINFO' => 's', 'VAR_TEMPLATE' => 't', 'VAR_FILTERS' => 'filter_exp', 'HTTP_CACHE_CONTROL' => 'private', 'CHECK_APP_DIR' => true, 'FILE_UPLOAD_TYPE' => 'Local', 'DATA_CRYPT_TYPE' => 'MyMVC', )); Hook::getTag(array ( 'app_init' => array ( 0 => 'Behavior\\BuildLiteBehavior', ), 'app_begin' => array ( 0 => 'Behavior\\ReadHtmlCacheBehavior', ), 'app_end' => array ( 0 => 'Behavior\\ShowPageTraceBehavior', ), 'view_parse' => array ( 0 => 'Behavior\\ParseTemplateBehavior', ), 'template_filter' => array ( 0 => 'Behavior\\TemplateCacheReplaceBehavior', ), 'view_filter' => array ( 0 => 'Behavior\\WriterStaticHTMLCacheBehavior', ), ));}